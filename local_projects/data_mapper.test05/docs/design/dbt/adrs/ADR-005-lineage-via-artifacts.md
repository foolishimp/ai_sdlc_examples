# ADR-005: Lineage via dbt Artifacts

**Status**: Proposed
**Date**: 2026-02-21
**Requirements**: REQ-F-SYN-003, REQ-NFR-OBS-001, REQ-F-TRV-004, REQ-DATA-LIN-001, REQ-DATA-LIN-002, REQ-NFR-OBS-002

## Context

The CDME requirements demand full lineage traceability (REQ-F-SYN-003): every target value must be traceable to its source entity, epoch, and morphism path. Additionally, lineage must be emitted as OpenLineage events (REQ-NFR-OBS-001), and operational telemetry must capture per-morphism statistics (REQ-F-TRV-004).

dbt produces several artifacts that contain lineage information:

- **manifest.json**: Contains the full model DAG, including source-to-model and model-to-model dependencies. In dbt 1.6+, includes column-level lineage when SQL is parseable.
- **run_results.json**: Contains per-model execution statistics (timing, row counts, status).
- **catalog.json**: Contains column types and descriptions (generated by `dbt docs generate`).
- **sources.json**: Contains source freshness check results.

These artifacts collectively provide model-level and (partially) column-level lineage, execution telemetry, and type metadata. However, they do NOT provide:
- **Record-level lineage**: Which specific input records contributed to a specific output record.
- **In-flight telemetry**: Statistics captured during transformation execution (Writer Effect).
- **Morphism-path lineage**: The specific chain of transformations a value passed through (only the model DAG, not the SQL-internal logic).

## Decision

We will use dbt's native artifacts (manifest.json, run_results.json, catalog.json) as the primary lineage source. The **cdme_lineage_service** transforms these into OpenLineage events and enriches them with:

1. **REQ key tags**: Extracted from model `meta.implements` fields in manifest.json.
2. **Accounting metadata**: Read from warehouse metadata tables (cdme_reverse_join_*, cdme_error_log, cdme_filtered_keys_*).
3. **Run context**: Epoch date, lookup versions, artifact versions from dbt vars and git SHA.

For **record-level lineage** (Full Lineage mode per REQ-DATA-LIN-001), the lineage service must combine dbt model-level lineage with the adjoint service's per-record metadata tables. This is the only way to trace a specific target record back to its source records in dbt.

## Rationale

dbt's artifact system is well-designed and comprehensive for model-level lineage. Rather than building a custom lineage capture system, leveraging dbt artifacts provides:

- **Zero additional runtime cost**: Artifacts are produced as a side effect of `dbt run` and `dbt docs generate`.
- **Automatic maintenance**: As models are added/removed, the manifest automatically updates.
- **Column-level lineage**: dbt 1.6+ parses SQL to extract column-to-column lineage (when SQL is parseable; complex Jinja may defeat the parser).
- **Community standard**: dbt artifacts are well-documented and widely used by the data ecosystem (Elementary, re_data, etc.).

The gap between dbt's model-level lineage and CDME's record-level lineage requirement is bridged by the adjoint service's metadata tables. This two-layer approach (model-level from dbt, record-level from adjoint service) provides both broad and deep lineage.

### Alternatives Considered

1. **Custom lineage capture in every dbt model**: Embed lineage capture SQL in every model (e.g., INSERT INTO lineage_table for every row processed). Rejected because: this would significantly impact model performance, double the write volume, make models harder to read and maintain, and violate dbt's design principle that models should focus on transformation logic. The post-run approach via the adjoint service is cleaner, even if slightly less efficient.

2. **OpenLineage dbt integration (openlineage-dbt)**: Use the existing openlineage-dbt package that hooks into dbt's event system. This is a viable supplementary tool but rejected as the primary approach because: it provides model-level lineage only (same as manifest.json parsing), it does not handle CDME-specific requirements (accounting, REQ key tagging, adjoint metadata), and it does not support the run-completion gate. The cdme_lineage_service must exist regardless, so it subsumes the openlineage-dbt functionality.

## Consequences

### Positive
- Leverages dbt's existing, well-tested artifact system — no custom lineage infrastructure
- Zero runtime overhead for model-level lineage capture
- Column-level lineage available for parseable SQL (dbt 1.6+)
- OpenLineage events are constructed from rich metadata (model names, column types, execution stats)
- REQ key tags in model meta flow automatically into lineage events
- Artifact versioning is inherent (git SHA + dbt project version)

### Negative
- Column-level lineage may be incomplete for complex Jinja expressions that dbt's SQL parser cannot follow
- Record-level lineage requires the adjoint service (additional infrastructure and post-run processing)
- Telemetry (REQ-F-TRV-004) is limited to per-model aggregates (row count, timing) rather than per-record Writer Effect accumulation
- The lineage service must be kept in sync with dbt project structure changes (new models, renamed models)
- dbt artifacts are large for big projects (manifest.json can be tens of MB) — parsing performance matters

### Mitigations
- Complex Jinja expressions are documented with manual column lineage annotations in YAML when the parser cannot follow
- The adjoint service is a required companion service, not optional — record-level lineage is always available in Full Lineage mode
- Per-model telemetry from run_results is sufficient for most monitoring use cases; per-record telemetry is a known gap documented in ADR-003
- The lineage service uses incremental manifest parsing (only process changed models) for performance
- Manifest changes are detected by comparing git diffs of model files

## References

- REQUIREMENTS.md v1.0.0 sections 3.5 (Synthesis — lineage), 4.3 (Observability), 5.1 (Lineage)
- dbt artifacts documentation: https://docs.getdbt.com/reference/artifacts
- OpenLineage specification: https://openlineage.io
- ADR-002 (hybrid architecture — lineage service is one of the companion services)
- ADR-003 (REQ-F-TRV-004 Writer Effect documented as partially satisfied)
